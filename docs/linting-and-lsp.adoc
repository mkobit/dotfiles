= Buildifier and LSP Integration
:toc:
:toclevels: 3

This document explains how to use the integrated buildifier linting and Language Server Protocol (LSP) support in this Bazel-based dotfiles project.

== Overview

This project provides comprehensive tooling for Bazel development:

. **Buildifier Integration**: Automated formatting and linting of BUILD files using `aspect_rules_lint`
. **LSP Support**: Language server setup for enhanced IDE support
. **Automated Quality Checks**: CI/CD integration for code quality

== Buildifier (Bazel File Linting and Formatting)

=== Available Commands

==== Format all BUILD files
[source,bash]
----
# Format all Bazel files in the repository
bazel run //:format

# Format files in a specific package
bazel run //src/git:format
----

==== Test formatting (for CI)
[source,bash]
----
# Test that all files are properly formatted
bazel test //:format_test

# Test formatting in a specific package
bazel test //src/git:format_test
----

==== Run all quality checks
[source,bash]
----
# Run comprehensive quality checks
bazel test //:quality_checks
----

=== Integration in Packages

To add buildifier support to a new package, add these lines to your `BUILD.bazel`:

[source,starlark]
----
load("//rules:linting.bzl", "bazel_files_format", "bazel_files_format_test")

# Format Bazel files in this package
bazel_files_format(
    name = "format",
)

# Test that Bazel files are properly formatted
bazel_files_format_test(
    name = "format_test",
)
----

=== Configuration

Buildifier behavior is configured in `.bazelrc`:

[source,ini]
----
# Enable buildifier and linting tools
lint --aspects=@aspect_rules_lint//lint:defs.bzl%lint_aspect
lint --output_groups=+rules_lint_report

# Buildifier configuration
build --@aspect_rules_lint//lint:format=buildifier
----

== Language Server Protocol (LSP) Support

=== Setup LSP for Your IDE

[source,bash]
----
# Generate LSP configuration files
bazel run //:lsp_setup

# Generate compile_commands.json for C/C++ support
bazel run //:compile_commands
----

=== Supported IDEs

==== Visual Studio Code
After running `bazel run //:lsp_setup`, VSCode will be configured with:

* Bazel LSP integration
* Proper environment variables
* Starlark syntax highlighting
* BUILD file formatting on save

==== Other IDEs
The LSP setup generates configuration for:

* **Vim/Neovim**: LSP client configuration
* **Emacs**: LSP mode setup
* **IntelliJ**: Bazel plugin configuration

=== LSP Features

* **Syntax highlighting** for `.bzl` and `BUILD` files
* **Go-to-definition** for Bazel targets and rules
* **Auto-completion** for Bazel functions and attributes
* **Error highlighting** for syntax errors
* **Format-on-save** integration with buildifier

== CI/CD Integration

=== GitHub Actions

The project includes automated quality checks in `.github/workflows/bazel.yaml`:

[source,yaml]
----
- name: Run quality checks
  run: bazel test //:quality_checks
----

=== Pre-commit Hooks

You can set up pre-commit hooks to run formatting automatically:

[source,bash]
----
# Add to .git/hooks/pre-commit
#!/bin/bash
bazel test //:format_test
----

== Advanced Usage

=== Custom Linting Rules

You can extend the linting system by modifying `rules/linting.bzl`:

[source,starlark]
----
def custom_lint_rule(name, srcs, **kwargs):
    """Custom linting rule for specific file types."""
    # Implementation here
----

=== LSP Customization

Modify `rules/lsp.bzl` to add support for additional language servers:

[source,starlark]
----
def setup_custom_lsp(name, language, **kwargs):
    """Setup LSP for additional languages."""
    # Implementation here
----

== Troubleshooting

=== Common Issues

==== Buildifier not found
Ensure `aspect_rules_lint` is properly loaded in `MODULE.bazel`:

[source,starlark]
----
bazel_dep(name = "aspect_rules_lint", version = "1.4.4")
----

==== LSP not working in IDE
1. Run `bazel run //:lsp_setup` to regenerate configuration
2. Restart your IDE
3. Check that the Bazel LSP extension is installed

==== Formatting tests failing
Run the formatter to fix issues:

[source,bash]
----
bazel run //:format
----

=== Debug Commands

[source,bash]
----
# Check what files will be formatted
bazel query 'kind("format_multirun", //...)'

# Verbose linting output
bazel test //:format_test --test_output=all
----

== References

* https://github.com/aspect-build/rules_lint[aspect_rules_lint documentation]
* https://github.com/bazelbuild/buildtools/tree/master/buildifier[Buildifier documentation]
* https://microsoft.github.io/language-server-protocol/[Language Server Protocol specification]
