= Guarded Installation
:toc: left
:toclevels: 3
:icons: font

== Overview

The guarded installation system allows you to safely inject dotfiles configuration content into existing user files without overwriting them. This is particularly useful for adding `[include]` sections to files like `~/.gitconfig` or sourcing statements to `~/.zshrc`.

== How It Works

The guarded install rule creates an executable that:

1. **Checks for existing content**: Looks for a managed section with a specific label
2. **Preserves user content**: Never overwrites existing user configurations
3. **Updates safely**: If the managed section exists, it updates only that section
4. **Adds new content**: If no managed section exists, it appends the new content with guard comments

== Guard Structure

When content is installed, it's wrapped with guard comments:

[source,bash]
----
# dotfiles installed //src/git:install_config_home
# START DOTFILES MANAGED SECTION
[include]
    path = ~/.config/git/personal-config
# END DOTFILES MANAGED SECTION
----

The structure includes:

* **Header comment**: Identifies which Bazel target installed the content
* **Start guard**: Marks the beginning of the managed section
* **Content**: The actual configuration content to inject
* **End guard**: Marks the end of the managed section

== Usage

=== Basic Example

[source,starlark]
----
load("//rules:guarded_install.bzl", "guarded_install")

guarded_install(
    name = "install_config_home",
    target_file = "~/.gitconfig",
    content = ":gitconfig",
    header_comment = "#",
    guard_start = "START DOTFILES MANAGED SECTION",
    guard_end = "END DOTFILES MANAGED SECTION",
)
----

Then run:

[source,bash]
----
bazel run //src/git:install_config_home
----

=== Content Sources

You can use either a content file or a built Bazel target as the content source:

*Built targets* (recommended):
[source,starlark]
----
content = ":gitconfig",  # Use the built gitconfig target
----

*Content files*:
[source,starlark]
----
content = "install_content.txt",  # Use a static content file
----

== Examples by Tool

=== Git Configuration

[source,starlark]
----
# src/git/BUILD.bazel
guarded_install(
    name = "install_config_home",
    target_file = "~/.gitconfig",
    content = ":gitconfig",
)
----

Uses the built gitconfig target (`:gitconfig`) which contains the complete generated configuration.

Usage:
[source,bash]
----
bazel run //src/git:install_config_home
----

=== ZSH Configuration

[source,starlark]
----
# src/zsh/BUILD.bazel
guarded_install(
    name = "install_config_home",
    target_file = "~/.zshrc",
    content = ":generated_zshrc",
)
----

Uses the built zshrc target (`:generated_zshrc`) which contains the complete generated ZSH configuration.

Usage:
[source,bash]
----
bazel run //src/zsh:install_config_home
----

== Rule Parameters

[cols="1,1,3"]
|===
|Parameter |Type |Description

|`name`
|string
|Name of the rule

|`target_file`
|string
|Path to the target file (supports `~/` expansion)

|`content`
|label
|Content file to inject between guards

|`header_comment`
|string
|Comment character(s) to use (default: `"#"`)

|`guard_start`
|string
|Start guard text (default: `"START DOTFILES MANAGED SECTION"`)

|`guard_end`
|string
|End guard text (default: `"END DOTFILES MANAGED SECTION"`)
|===

== Safety Features

=== Atomic Operations

* Uses temporary files for all operations
* Only replaces the target file after successful completion
* Preserves file permissions and ownership

=== Content Preservation

* Never overwrites existing user content
* Only manages the specific section between guards
* Preserves content before and after the managed section

=== Idempotent Operations

* Running the same install multiple times is safe
* Updates existing managed sections rather than appending
* Detects existing managed sections accurately

== Best Practices

=== Content Organization

* Keep content files small and focused
* Use descriptive names for content files
* Group related configurations together

=== Target File Selection

* Use standard configuration file locations
* Support `~/` expansion for user home directories
* Consider platform-specific paths when needed

=== Guard Comments

* Use comment syntax appropriate for the target file format
* Choose descriptive guard text that won't conflict with existing content
* Keep guard text consistent across related installations

== Troubleshooting

=== Common Issues

[cols="1,3"]
|===
|Issue |Solution

|Content file not found
|Ensure the content file is listed in the BUILD.bazel file and exists

|Permission denied
|Check that the target directory exists and is writable

|Existing content corrupted
|The tool creates backups; restore from backup if needed

|Multiple managed sections
|Remove duplicate sections manually, then re-run the install
|===

=== Debugging

To see what the install script would do without running it:

[source,bash]
----
# Build the script
bazel build //src/git:install_config_home

# Examine the generated script
cat bazel-bin/src/git/install_config_home_install_script.sh

# Test with a copy of your file
cp ~/.gitconfig /tmp/test_gitconfig
# Edit the script to target /tmp/test_gitconfig for testing
----
