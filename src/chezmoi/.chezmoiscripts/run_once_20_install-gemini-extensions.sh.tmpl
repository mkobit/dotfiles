#!/bin/bash
{{/* Calculate hash from sorted JSON of extensions map for change detection in the script content itself */ -}}
{{- $extensionsJson := .gemini.extensions | default dict | toJson -}}
# gemini.extensions hash: {{ $extensionsJson | sha256sum }}

set -euo pipefail

# Source logging library from chezmoi source
CHEZMOI_SOURCE_DIR="{{ .chezmoi.sourceDir }}"
source "${CHEZMOI_SOURCE_DIR}/.chezmoitemplates/shell/logging.sh"

# Ensure gemini (via mise) is in PATH
export PATH="{{ .chezmoi.destDir }}/.local/bin:${PATH}"

log_info "Ensuring Gemini CLI extensions are installed..."

if ! command -v gemini &> /dev/null; then
    log_warn "gemini command not found in PATH. Skipping extension installation."
    exit 0
fi

{{- range $name, $ext := .gemini.extensions }}
{{-   if $ext.enabled }}
log_info "Installing/Updating extension: {{ $name }} ({{ $ext.ref }})"
# We use --consent to bypass prompts.
if ! gemini extensions install "{{ $ext.url }}" --ref "{{ $ext.ref }}" --consent; then
    log_warn "Failed to install {{ $name }}. It may already be installed or there was a network error."
fi
{{-   end }}
{{- end }}

log_success "Gemini extensions installation complete."
