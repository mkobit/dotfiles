#!/bin/bash
{{- /* Calculate hash from sorted JSON of extensions map for change detection */ -}}
{{- $extensionsJson := .gemini.extensions | default dict | toJson -}}
{{- $extensionsHash := $extensionsJson | sha256sum }}
# gemini.extensions hash: {{ $extensionsHash }}

set -euo pipefail

# logging.sh hash: {{ includeTemplate "shell/logging.sh" | sha256sum }}
source "${CHEZMOI_SOURCE_DIR:?}/.chezmoitemplates/shell/logging.sh"

log_info "Ensuring Gemini CLI extensions are installed..."

if ! command -v gemini &> /dev/null; then
    log_error "gemini command not found, skipping extension installation."
    exit 0
fi

{{- range $name, $ext := .gemini.extensions }}
{{-   if $ext.enabled }}
log_info "Installing/Updating extension: {{ $name }} ({{ $ext.ref }})"
if ! gemini extensions install "{{ $ext.url }}" --ref "{{ $ext.ref }}" --consent; then
    log_warn "Failed to install {{ $name }}. It may already be installed or there was a network error."
fi
{{-   end }}
{{- end }}

log_success "Gemini extensions installation complete."
