{{- /* Reusable template for Bazel-built Python tool externals
     *
     * Usage in .chezmoiexternals/*.toml.tmpl:
     *   {{- includeTemplate "dotfiles_bazel_python_tool.toml" (dict "target" "//src/python/my_tool:my_tool_exe" "name" "my_tool" "sourceDir" .chezmoi.sourceDir) -}}
     *
     * Parameters:
     *   - target: Bazel target label (e.g., "//src/python/hello_world:hello_world_exe")
     *   - name: Install name (e.g., "hello_world")
     *   - sourceDir: The chezmoi source directory (used to set CWD for bazel commands)
     */ -}}
{{- $target := .target -}}
{{- $name := .name -}}
{{- $sourceDir := .sourceDir -}}
{{- /* Ensure we run bazel from within the source directory so it can find the workspace */ -}}
{{- $cqueryCmd := printf "cd %s && bazel cquery --output=files %s" ($sourceDir | quote) $target -}}
{{- $relPath := output "sh" "-c" $cqueryCmd | trim -}}
{{- $infoCmd := printf "cd %s && bazel info workspace" ($sourceDir | quote) -}}
{{- $workspaceRoot := output "sh" "-c" $infoCmd | trim -}}
{{- $artifactPath := printf "%s/%s" $workspaceRoot $relPath -}}

["{{ $name }}"]
type = "file"
url = {{ printf "file://%s" $artifactPath | quote }}
executable = true
refreshPeriod = "0"
