{{- /* Reusable template for Bazel-built Python tool externals
     *
     * Usage in .chezmoiexternals/*.toml.tmpl:
     *   {{- includeTemplate "dotfiles_bazel_python_tool.toml" (dict "target" "//src/python/my_tool:my_tool_exe" "name" "my_tool") -}}
     *
     * Parameters:
     *   - target: Bazel target label (e.g., "//src/python/hello_world:hello_world_exe")
     *   - name: Install name (e.g., "hello_world")
     */ -}}
{{- $target := .target -}}
{{- $name := .name -}}
{{- /* Build the target first to ensure the artifact exists */ -}}
{{- $buildCmd := printf "cd \"${CHEZMOI_SOURCE_DIR}\" && bazel build %s >/dev/null 2>&1" $target -}}
{{- output "sh" "-c" $buildCmd -}}
{{- /* Query the output file path using CHEZMOI_SOURCE_DIR to locate the workspace */ -}}
{{- $cqueryCmd := printf "cd \"${CHEZMOI_SOURCE_DIR}\" && bazel cquery --output=files %s" $target -}}
{{- $relPath := output "sh" "-c" $cqueryCmd | trim -}}
{{- /* Use execution_root because cquery output is relative to it, and it avoids relying on workspace symlinks */ -}}
{{- $infoCmd := printf "cd \"${CHEZMOI_SOURCE_DIR}\" && bazel info execution_root" -}}
{{- $execRoot := output "sh" "-c" $infoCmd | trim -}}
{{- $artifactPath := printf "%s/%s" $execRoot $relPath -}}

["{{ $name }}"]
type = "file"
url = {{ printf "file://%s" $artifactPath | quote }}
executable = true
refreshPeriod = "0"
