#!/bin/bash
# vim: set ft=sh
{{- /* Calculate hash from sorted JSON of plugins array for change detection */ -}}
{{- $pluginsJson := .asdf.plugins | sortAlpha | toJson -}}
{{- $pluginsHash := $pluginsJson | sha256sum -}}
# run_once_install-asdf-{{ $pluginsHash }}.sh.tmpl
#
# Manages asdf plugins based on configuration in .chezmoidata/asdf.toml.
# The asdf binary is installed to ~/.local/bin via chezmoi externals.
# This script re-runs when the plugins array changes (tracked via JSON hash).
#
# Script logic:
# 1. Check if asdf is enabled in chezmoi data.
# 2. Verify asdf binary is available.
# 3. Sync plugins: install missing, remove unlisted.
#
# Note: This script does NOT install tool versions. Tool versions should be
# managed per-project using .tool-versions files in project directories.
#
# References:
# - https://asdf-vm.com/guide/getting-started.html

set -euo pipefail

{{- if .asdf.enabled }}

source "${CHEZMOI_SOURCE_DIR:?}/scripts/logging.sh"

# --- Verify asdf is accessible ---
if ! command -v asdf >/dev/null 2>&1; then
  log_error "asdf binary not found in PATH"
  log_error "Expected location: ~/.local/bin/asdf (installed via chezmoi externals)"
  exit 1
fi

log_info "asdf version: $(asdf version)"

# Define desired plugins from chezmoi data
declare -a DESIRED_PLUGINS=(
{{- range .asdf.plugins }}
  "{{ .name }}"
{{- end }}
)

# --- Remove Unlisted Plugins ---
log_info "Checking for plugins to remove..."
while IFS= read -r installed_plugin; do
  found=false
  for desired_plugin in "${DESIRED_PLUGINS[@]}"; do
    if [[ "$installed_plugin" == "$desired_plugin" ]]; then
      found=true
      break
    fi
  done
  if [[ "$found" == false ]]; then
    log_warn "Removing unlisted plugin: $installed_plugin"
    asdf plugin remove "$installed_plugin"
  fi
done < <(asdf plugin list 2>/dev/null || true)

# --- Install Missing Plugins ---
log_info "Checking for plugins to install..."
{{- range .asdf.plugins }}
if ! asdf plugin list | grep -qF "{{ .name }}"; then
  log_info "Installing asdf plugin: {{ .name }}"
  asdf plugin add {{ .name }}
  log_success "Installed plugin: {{ .name }}"
fi
{{- end }}

log_success "asdf plugin management complete"

{{- end }}