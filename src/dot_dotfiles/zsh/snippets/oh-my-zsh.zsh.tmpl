#!/usr/bin/env zsh
# =============================================================================
# OH-MY-ZSH LOADER & CONFIGURATION
# =============================================================================
# This script configures and sources oh-my-zsh.
# oh-my-zsh is installed and managed by chezmoi.

# =============================================================================
# THEME
# =============================================================================
{{ if .zsh.oh-my-zsh.powerlevel10k.enabled }}
ZSH_THEME="powerlevel10k/powerlevel10k"
{{ else }}
# robbyrussell is the fastest theme, perfect for tmux performance
ZSH_THEME="robbyrussell"
{{ end }}

# =============================================================================
# PLUGINS
# =============================================================================
plugins=(
    {{- range .zsh.oh-my-zsh.plugins }}
    {{ . | quote }}
    {{- end }}
)

# =============================================================================
# PERFORMANCE OPTIMIZATIONS
# =============================================================================
# Disable features that slow down shell startup
DISABLE_AUTO_UPDATE="true"         # Manual updates only
DISABLE_UPDATE_PROMPT="true"       # No update prompts
COMPLETION_WAITING_DOTS="false"    # No dots while waiting
DISABLE_MAGIC_FUNCTIONS="true"     # Disable magic functions for speed

# Tmux-specific optimizations (must be set before oh-my-zsh loads)
if [[ -n "$TMUX" ]]; then
    DISABLE_AUTO_TITLE="true"       # Disable auto-title in tmux for performance
fi

# Set the ZSH environment variable to the chezmoi-managed location
export ZSH="$HOME/.oh-my-zsh"

# Load oh-my-zsh
if [[ -f "$ZSH/oh-my-zsh.sh" ]]; then
    source "$ZSH/oh-my-zsh.sh"
else
    echo -e "\033[1;33m⚠️  oh-my-zsh.sh not found at $ZSH/oh-my-zsh.sh\033[0m"
fi

# =============================================================================
# POST-LOAD OPTIMIZATIONS
# =============================================================================
# Override oh-my-zsh defaults that don't work well with tmux
unsetopt CORRECT_ALL               # Only correct commands, not arguments
setopt CORRECT                     # Enable command correction

# CRITICAL: Set vi mode AFTER oh-my-zsh loads (oh-my-zsh resets to emacs mode)
bindkey -v                         # Enable vi mode (must be after oh-my-zsh)
export KEYTIMEOUT=1                # Fast ESC timeout for vi mode
