{{ with (index .zsh "oh-my-zsh") }}
{{ if eq .installation "external-sources" }}
#!/usr/bin/env zsh

{{ if .powerlevel10k.enabled }}
ZSH_THEME="powerlevel10k/powerlevel10k"
{{ else }}
# Default theme - simple and fast
ZSH_THEME="robbyrussell"
{{ end }}

plugins=(
    {{- range .plugins }}
    {{ . | quote }}
    {{- end }}
)

DISABLE_AUTO_UPDATE="true"         # Manual updates only, managed by chezmoi
DISABLE_UPDATE_PROMPT="true"       # No update prompts, managed by chezmoi
COMPLETION_WAITING_DOTS="false"    # No dots while waiting
DISABLE_MAGIC_FUNCTIONS="true"     # Disable magic functions for speed

# Tmux-specific optimizations (must be set before oh-my-zsh loads)
if [[ -n "$TMUX" ]]; then
    DISABLE_AUTO_TITLE="true"       # Disable auto-title in tmux for performance
fi

# Set the ZSH environment variable to the chezmoi-managed location
export ZSH="$HOME/.dotfiles/external/oh-my-zsh"

# Redirect cache directory to prevent chezmoi tracking runtime files
export ZSH_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/oh-my-zsh"

# Load oh-my-zsh
if [[ -f "$ZSH/oh-my-zsh.sh" ]]; then
    source "$ZSH/oh-my-zsh.sh"
else
    echo -e "\033[1;33m⚠️  oh-my-zsh.sh not found at $ZSH/oh-my-zsh.sh\033[0m"
fi

# =============================================================================
# POST-LOAD OPTIMIZATIONS
# =============================================================================
# Override oh-my-zsh defaults that don't work well with tmux
unsetopt CORRECT_ALL               # Only correct commands, not arguments
setopt CORRECT                     # Enable command correction

# CRITICAL: Set vi mode AFTER oh-my-zsh loads (oh-my-zsh resets to emacs mode)
bindkey -v                         # Enable vi mode (must be after oh-my-zsh)
export KEYTIMEOUT=1                # Fast ESC timeout for vi mode

# Enable bash completion compatibility
autoload -U +X bashcompinit && bashcompinit
{{- end }}
{{- end }}
