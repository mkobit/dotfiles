#!/bin/sh
{{/* Optimized sed patterns to work reliably on macOS and Linux systems */}}
tempfile="$(mktemp)"
trap 'rm -rf "${tempfile}"' EXIT
cat > "${tempfile}"

# Remove existing chezmoi section if present
sed -i.bak '/.*modify_dot_tmux\.conf\.tmpl:BEGIN:chezmoi:tmux/,/.*modify_dot_tmux\.conf\.tmpl:END:chezmoi:tmux/d' "${tempfile}"

# Check if file ends with newline, if not add one
if [ -s "${tempfile}" ] && [ "$(tail -c1 "${tempfile}")" != "" ]; then
  echo >> "${tempfile}"
fi

# Add our managed section
cat >> "${tempfile}" << 'EOF'
# {{ .chezmoi.workingTree }}/{{ .chezmoi.sourceFile }}:BEGIN:chezmoi:tmux:{{ include "modify_dot_tmux.conf.tmpl" | sha256sum | substr 0 8 }} - WARNING: managed by chezmoi, do not edit
source-file {{ .chezmoi.destDir }}/.dotfiles/tmux/config.tmux
# {{ .chezmoi.workingTree }}/{{ .chezmoi.sourceFile }}:END:chezmoi:tmux:{{ include "modify_dot_tmux.conf.tmpl" | sha256sum | substr 0 8 }}
EOF

cat "${tempfile}"